@Library('jenkins-shared-library') _

pipeline {
    agent {
        kubernetes {
            label 'jenkins-agent'
            defaultContainer 'tools'
        }
    }

    options {
        timeout(time: 25, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
    }

    triggers {
        pollSCM('H/2 * * * *')
    }

    environment {
        SNYK_TOKEN = credentials('SNYK_TOKEN')
        PYTHONPATH = "${WORKSPACE}"
        PATH = "/opt/jenkins_venv/bin:$PATH"
        APP_NAMESPACE = "demo-app"
    }

    stages {

        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Prepare Environment') {
            steps {
                container('tools') {
                    sh '''
                        echo "=== ×‘×“×™×§×ª ×”×ª×§× ×•×ª ×‘×¡×™×¡×™×•×ª ==="
                        git --version
                        python3 --version
                        pip3 --version
                        node --version
                        npm --version
                        kubectl version --client
                    '''
                }
            }
        }

        stage('Static Analysis') {
            parallel {

                stage('Pylint Analysis') {
                    steps {
                        container('tools') {
                            catchError(buildResult: 'SUCCESS', stageResult: 'UNSTABLE') {
                                sh '''
                                    mkdir -p reports/pylint
                                    pylint auth-service/*.py backend/*.py jewelry-store/*.py || true
                                '''
                            }
                        }
                    }
                }

                stage('Unit Tests') {
                    steps {
                        container('tools') {
                            catchError(buildResult: 'SUCCESS', stageResult: 'UNSTABLE') {
                                sh '''
                                    mkdir -p reports
                                    pytest --html=reports/unit_test_report.html --self-contained-html || true
                                '''
                            }
                        }
                    }
                }
            }
        }

        stage('Publish HTML Reports') {
            steps {
                container('tools') {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports/pylint',
                        reportFiles: 'pylint_report.txt',
                        reportName: 'Pylint Report'
                    ])

                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports',
                        reportFiles: 'unit_test_report.html',
                        reportName: 'Unit Test Report'
                    ])
                }
            }
        }

        stage('Deploy App in Kubernetes') {
            steps {
                container('tools') {
                    sh '''
                        echo "ğŸ“¦ Deploying application to namespace: ${APP_NAMESPACE}"

                        # Deployments
                        kubectl apply -f infra/k8s/auth-deployment.yaml -n ${APP_NAMESPACE}
                        kubectl apply -f infra/k8s/backend-deployment.yaml -n ${APP_NAMESPACE}
                        kubectl apply -f infra/k8s/fronted-deployment.yaml -n ${APP_NAMESPACE}

                        # Services
                        kubectl apply -f infra/k8s/service-auth.yaml -n ${APP_NAMESPACE}
                        kubectl apply -f infra/k8s/service-backend.yaml -n ${APP_NAMESPACE}
                        kubectl apply -f infra/k8s/service-fronted.yaml -n ${APP_NAMESPACE}

                        # HPA & KEDA (×× ×™×¢×ª ×›×©×œ ×”×¨×©××•×ª)
                        kubectl apply -f infra/k8s/auth-hpa.yaml -n ${APP_NAMESPACE} || true
                        kubectl apply -f infra/k8s/backend-hpa.yaml -n ${APP_NAMESPACE} || true
                        kubectl apply -f infra/k8s/frontend-hpa.yaml -n ${APP_NAMESPACE} || true
                        kubectl apply -f infra/k8s/auth-keda.yaml -n ${APP_NAMESPACE} || true
                        kubectl apply -f infra/k8s/backend-keda.yaml -n ${APP_NAMESPACE} || true
                        kubectl apply -f infra/k8s/fronted-keda.yaml -n ${APP_NAMESPACE} || true

                        # Ingress & PVC
                        kubectl apply -f infra/k8s/ingress.yaml -n ${APP_NAMESPACE} || true
                        kubectl apply -f infra/k8s/nginx-pvc.yaml -n ${APP_NAMESPACE} || true

                        echo "â³ Waiting for deployments rollout"
                        kubectl rollout status deployment/auth-deployment -n ${APP_NAMESPACE}
                        kubectl rollout status deployment/backend-deployment -n ${APP_NAMESPACE}
                        kubectl rollout status deployment/fronted-deployment -n ${APP_NAMESPACE}
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "âœ… ×”×¤×™×™×¤×œ×™×™×Ÿ ×”×¡×ª×™×™× ×‘×”×¦×œ×—×” ××œ××”"
        }
        unstable {
            echo "âš ï¸ ×”×¤×™×™×¤×œ×™×™×Ÿ ×”×¡×ª×™×™× ×¢× ××–×”×¨×•×ª (×œ×™× ×˜ / ×‘×“×™×§×•×ª)"
        }
        failure {
            echo "âŒ ×”×¤×™×™×¤×œ×™×™×Ÿ × ×›×©×œ â€“ ×‘×“×§×™ ×œ×•×’×™×"
        }
    }
}
